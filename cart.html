<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Gi·ªè h√†ng - C√† Ph√™ ƒê·∫≠m ƒê√†</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="styles/user.css" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <div class="container nav">
                <div class="brand">
                    <a href="index.html">
                        <img
                            src="https://scontent-hkg4-2.xx.fbcdn.net/v/t1.15752-9/552703956_771855105468883_1116774372539651057_n.png?_nc_cat=111&ccb=1-7&_nc_sid=0024fc&_nc_eui2=AeHOBCj3lX8HaOlEvmrFw3xlBrfZDT56J6MGt9kNPnono-ZY8pwnFeBxIqW3onZN3zta5vYTCGt1khW091oaxsr0&_nc_ohc=gpp9itW4IqcQ7kNvwEoG1Qq&_nc_oc=Admu0eUlmvebDWAO50DQbndetZfv1eoK4Pdnm2Fql2WZTtukjFnDuqMCp5j7orfE930&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-hkg4-2.xx&oh=03_Q7cD3QHC08gLgVHXrZ8zt8znzke_wz-InehjvWetDnfV-WoDKQ&oe=68FBBCA9"
                            alt="Logo C√† Ph√™ ƒê·∫≠m ƒê√†"
                            class="brand-logo"
                        />
                        <span class="brand-name">C√† Ph√™ ƒê·∫≠m ƒê√†</span>
                    </a>
                </div>
                <form
                    class="search-bar"
                    role="search"
                    id="searchForm"
                    onsubmit="handleSearch(event)"
                >
                    <button class="search-btn" type="submit">üîç</button>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="T√¨m s·∫£n ph·∫©m..."
                        aria-label="T√¨m ki·∫øm"
                    />
                </form>

                <nav class="menu" aria-label="Ch√≠nh">
                    <a href="products.html">S·∫£n ph·∫©m</a>
                    <a href="index.html#ve-chung-toi">Gi·ªõi thi·ªáu</a>
                    <a href="index.html#loi-ich">L·ª£i √≠ch</a>
                    <a href="index.html#lien-he">Li√™n h·ªá</a>
                    <a href="order-history.html" style="margin-right: 10px">
                        <i class="fas fa-history"></i> ƒê∆°n h√†ng
                    </a>
                    <a href="cart.html" class="badge" aria-label="Gi·ªè h√†ng">
                        Gi·ªè h√†ng
                        <span id="cart-badge" class="badge-count">0</span>
                    </a>
                </nav>

                <button
                    id="menuBtn"
                    class="mobile-toggle"
                    aria-expanded="false"
                    aria-controls="mobileMenu"
                >
                    Menu
                </button>
            </div>
        </header>

        <nav id="mobileMenu" hidden class="mobile-menu"></nav>

        <main class="container" style="padding: 24px 20px">
            <h1 class="section-title">Gi·ªè h√†ng c·ªßa b·∫°n</h1>
            <div
                style="
                    display: grid;
                    grid-template-columns: 1.2fr 0.8fr;
                    gap: 20px;
                    align-items: start;
                    margin-top: 16px;
                "
            >
                <!-- Cart items -->
                <section
                    style="
                        background: #fff;
                        border-radius: 12px;
                        padding: 16px;
                        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
                    "
                >
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            margin-bottom: 10px;
                        "
                    >
                        <input type="checkbox" id="selectAll" />
                        <label
                            for="selectAll"
                            style="user-select: none; cursor: pointer"
                            >Ch·ªçn t·∫•t c·∫£</label
                        >
                    </div>
                    <div id="cartItems"></div>
                </section>

                <!-- Summary -->
                <aside
                    style="
                        background: #fff;
                        border-radius: 12px;
                        padding: 16px;
                        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
                        position: sticky;
                        top: 84px;
                    "
                >
                    <h3>T·ªïng k·∫øt</h3>
                    <div style="display: grid; gap: 8px; margin-top: 10px">
                        <div
                            style="
                                display: flex;
                                justify-content: space-between;
                            "
                        >
                            <span>ƒê√£ ch·ªçn</span
                            ><strong id="selectedCount">0</strong>
                        </div>
                        <div
                            style="
                                display: flex;
                                justify-content: space-between;
                            "
                        >
                            <span>T·∫°m t√≠nh</span
                            ><strong id="subtotal">0ƒë</strong>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 12px">
                        <a
                            href="products.html"
                            style="
                                flex: 1;
                                text-align: center;
                                padding: 12px 14px;
                                background: #fff;
                                color: #333;
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                font-weight: 600;
                            "
                            >Ti·∫øp t·ª•c mua</a
                        >
                        <a
                            href="checkout.html"
                            style="
                                flex: 1;
                                text-align: center;
                                padding: 12px 14px;
                                background: var(--gold);
                                color: var(--coffee-900);
                                border: none;
                                border-radius: 8px;
                                font-weight: 600;
                            "
                            >Thanh to√°n</a
                        >
                    </div>
                </aside>
            </div>
        </main>

        <footer id="lien-he">
            <div class="container foot">
                <div>
                    <h4>C√† Ph√™ ƒê·∫≠m ƒê√†</h4>
                    <p>
                        H·∫°t c√† ph√™ rang xay ch·∫•t l∆∞·ª£ng cao. ƒê·ªìng h√†nh c√πng ly c√†
                        ph√™ ngon m·ªói ng√†y.
                    </p>
                </div>
                <div>
                    <h4>Li√™n h·ªá</h4>
                    <p>Hotline: 0901 234 567<br />Email: hello@caphedamda.vn</p>
                </div>
                <div>
                    <h4>ƒê·ªãa ch·ªâ</h4>
                    <p>123 Phin Street, Qu·∫≠n Caffeine, TP.HCM</p>
                </div>
            </div>
            <div class="container copyright">
                ¬© 2025 C√† Ph√™ ƒê·∫≠m ƒê√†. All rights reserved.
            </div>
        </footer>

        <script type="module">
            import { session } from "./scripts/utils.js";

            // Utility functions
            function formatCurrency(v) {
                return new Intl.NumberFormat("vi-VN").format(v);
            }

            function getCart() {
                try {
                    return JSON.parse(localStorage.getItem("cart") || "[]");
                } catch {
                    return [];
                }
            }

            function setCart(cart) {
                localStorage.setItem("cart", JSON.stringify(cart));

                // Also save to user-specific storage if user is logged in
                const user = session.getUser();
                if (user) {
                    try {
                        const carts = JSON.parse(
                            localStorage.getItem("userCarts") || "{}"
                        );
                        carts[user.id] = cart;
                        localStorage.setItem(
                            "userCarts",
                            JSON.stringify(carts)
                        );
                    } catch (e) {
                        console.error("Error saving to user-specific cart:", e);
                    }
                }

                updateCartBadge();
            }

            // Update cart badge in the header
            function updateCartBadge() {
                const cart = getCart();
                // Show number of distinct items on the cart page
                const distinctCount = cart.length;
                const badge = document.getElementById("cart-badge");
                if (badge) {
                    badge.textContent =
                        distinctCount > 0 ? String(distinctCount) : "";
                    badge.style.display = distinctCount > 0 ? "flex" : "none";
                }
                return distinctCount;
            }

            // Get selected item IDs from localStorage
            function getSelectedIds() {
                try {
                    // First try to get from generic storage
                    const genericSelected = JSON.parse(
                        localStorage.getItem("cart_selected") || "[]"
                    );
                    if (genericSelected.length > 0) {
                        return new Set(genericSelected);
                    }

                    // If no generic selection, try user-specific storage
                    const user = session.getUser();
                    if (user) {
                        const selectedCarts = JSON.parse(
                            localStorage.getItem("userCartSelected") || "{}"
                        );
                        const userSelected = selectedCarts[user.id] || [];
                        return new Set(userSelected);
                    }

                    return new Set();
                } catch {
                    return new Set();
                }
            }

            // Save selected item IDs to localStorage
            function setSelectedIds(ids) {
                localStorage.setItem(
                    "cart_selected",
                    JSON.stringify(Array.from(ids))
                );

                // Also save to user-specific storage if user is logged in
                const user = session.getUser();
                if (user) {
                    try {
                        const selectedCarts = JSON.parse(
                            localStorage.getItem("userCartSelected") || "{}"
                        );
                        selectedCarts[user.id] = Array.from(ids);
                        localStorage.setItem(
                            "userCartSelected",
                            JSON.stringify(selectedCarts)
                        );
                    } catch (e) {
                        console.error(
                            "Error saving selected items to user-specific storage:",
                            e
                        );
                    }
                }
            }

            // Handle item selection toggle
            function onToggleSelect(e) {
                const id = e.target.closest(".cart-item")?.dataset.id;
                if (!id) return;
                const selected = getSelectedIds();
                if (e.target.checked) {
                    selected.add(id);
                } else {
                    selected.delete(id);
                }
                setSelectedIds(selected);
                updateCartSummary();
            }

            // Update cart summary (selected items count and subtotal)
            function updateCartSummary() {
                const cart = getCart();
                const selectedIds = getSelectedIds();
                const selectedItems = cart.filter((item) => selectedIds.has(item.id));

                let totalItems = 0;
                let subtotal = 0;

                selectedItems.forEach((item) => {
                    totalItems += item.quantity;
                    subtotal += (item.price || 0) * item.quantity;
                });

                const selectedCountEl = document.getElementById("selectedCount");
                const subtotalEl = document.getElementById("subtotal");
                const checkoutBtn = document.querySelector('a[href="checkout.html"]');

                if (selectedCountEl) selectedCountEl.textContent = totalItems;
                if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal) + "ƒë";

                // Update checkout button state
                if (checkoutBtn) {
                    if (selectedItems.length === 0) {
                        checkoutBtn.style.opacity = "0.6";
                        checkoutBtn.style.pointerEvents = "none";
                        checkoutBtn.title = "Vui l√≤ng ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n";
                    } else {
                        checkoutBtn.style.opacity = "1";
                        checkoutBtn.style.pointerEvents = "auto";
                        checkoutBtn.title = "";
                    }
                }

                return selectedItems.length > 0;
            }

            // Update item quantity in cart
            function updateQuantity(id, quantity) {
                const cart = getCart();
                const item = cart.find((i) => i.id === id);
                if (!item) return false;

                // Get available stock
                const availableStock = getAvailableStock(id);
                // Ensure quantity doesn't exceed available stock
                const newQuantity = Math.max(
                    1,
                    Math.min(quantity, availableStock)
                );

                // Only update if quantity changed
                if (newQuantity !== item.quantity) {
                    item.quantity = newQuantity;
                    setCart(cart);
                    render();
                    updateCartSummary();
                    return true;
                }
                return false;
            }

            // Event handlers
            function onInc(e) {
                const item = e.target.closest('.cart-item');
                if (!item) return;
                const id = item.dataset.id;
                const currentQuantity = parseInt(item.querySelector('.quantity-value').textContent);
                updateQuantity(id, currentQuantity + 1);
            }

            function onDec(e) {
                const item = e.target.closest('.cart-item');
                if (!item) return;
                const id = item.dataset.id;
                const currentQuantity = parseInt(item.querySelector('.quantity-value').textContent);
                if (currentQuantity > 1) {
                    updateQuantity(id, currentQuantity - 1);
                }
            }

            function onChange(e) {
                const item = e.target.closest('.cart-item');
                if (!item) return;
                const id = item.dataset.id;
                const newQuantity = parseInt(e.target.value);
                if (!isNaN(newQuantity) && newQuantity >= 1) {
                    updateQuantity(id, newQuantity);
                } else {
                    e.target.value = item.querySelector('.quantity-value').textContent;
                }
            }

            function onRemove(e) {
                // Removing items from cart is disabled in this build
                try { showToast('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m t·∫°i trang gi·ªè h√†ng', 'info'); } catch(e) {}
                return;
            }

            function onChangeNote(e) {
                // Notes are read-only in this cart implementation
                try { showToast('Ghi ch√∫ kh√¥ng kh·∫£ d·ª•ng', 'info'); } catch(e) {}
                return;
            }

            // Render cart items
            function render() {
                const box = document.getElementById("cartItems");
                const cart = getCart();
                const selectedIds = getSelectedIds();

                // If no selection saved and we have items, select all by default
                if (selectedIds.size === 0 && cart.length > 0) {
                    const allIds = new Set(cart.map((item) => item.id));
                    setSelectedIds(allIds);
                }

                if (cart.length === 0) {
                    box.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üõí</div>
                            <h3 style="margin: 0 0 10px;">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h3>
                            <p style="color: #666; margin-bottom: 20px;">H√£y th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu mua s·∫Øm</p>
                            <a href="products.html" class="btn" style="display: inline-block; padding: 10px 24px; background: #6f4e37; color: white; text-decoration: none; border-radius: 4px;">
                                Ti·∫øp t·ª•c mua s·∫Øm
                            </a>
                        </div>`;

                    const subtotalEl = document.getElementById("subtotal");
                    const selectedCountEl = document.getElementById("selectedCount");

                    if (subtotalEl) subtotalEl.textContent = "0ƒë";
                    if (selectedCountEl) selectedCountEl.textContent = "0";

                    return;
                }

                // Render items read-only: use stored image and price from cart entries
                box.innerHTML = cart.map((item) => {
                    const displayPrice = item.price || 0;
                    const isSelected = Array.from(selectedIds).includes(item.id);

                    return `
                    <div class="cart-item" data-id="${item.id}" style="padding: 16px 0; border-bottom: 1px solid #eee;">
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <div style="flex: 0 0 24px; padding-top: 4px;">
                                <input type="checkbox" class="select-item" ${isSelected ? 'checked' : ''} style="width:16px; height:16px; margin:0;">
                            </div>
                            <div style="width:80px; height:80px; flex:0 0 80px;">
                                <img src="${item.image || 'https://via.placeholder.com/80'}" alt="${item.name}" style="width:100%; height:100%; object-fit:cover; border-radius:4px;">
                            </div>
                            <div style="flex:1; min-width:0;">
                                <div style="margin-bottom:8px; font-weight:500;">${item.name}</div>
                                <div style="color:#d4a76a; font-weight:600; margin-bottom:12px;">${formatCurrency(displayPrice)}ƒë</div>
                                <div style="margin-top:6px; display:flex; align-items:center; gap:8px;">
                                    <div style="display:flex; align-items:center; border:1px solid #ddd; border-radius:4px;">
                                        <button class="quantity-btn dec" style="width:28px; height:28px; border:none; background:none; cursor:pointer; color:#666;">-</button>
                                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" style="width:40px; height:28px; border:none; text-align:center; -moz-appearance:textfield;" onchange="onChange(event)">
                                        <button class="quantity-btn inc" style="width:28px; height:28px; border:none; background:none; cursor:pointer; color:#666;">+</button>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align:right; font-weight:600; white-space:nowrap;">
                                ${formatCurrency(displayPrice * item.quantity)}ƒë
                            </div>
                        </div>
                    </div>`;
                    })
                    .join("");

                // Attach event listeners
                box.querySelectorAll(".select-item").forEach((inp) =>
                    inp.addEventListener("change", onToggleSelect)
                );
                
                // Add event listeners for quantity buttons
                box.querySelectorAll(".quantity-btn.inc").forEach((btn) =>
                    btn.addEventListener("click", onInc)
                );
                box.querySelectorAll(".quantity-btn.dec").forEach((btn) =>
                    btn.addEventListener("click", onDec)
                );

                // Update select all checkbox
                const selectAllCheckbox = document.getElementById("selectAll");
                if (selectAllCheckbox) {
                    const selectedCount = Array.from(selectedIds).filter((id) =>
                        cart.some((item) => item.id === id)
                    ).length;

                    selectAllCheckbox.checked =
                        selectedCount === cart.length && cart.length > 0;
                    selectAllCheckbox.indeterminate =
                        selectedCount > 0 && selectedCount < cart.length;

                    selectAllCheckbox.onchange = () => {
                        if (selectAllCheckbox.checked) {
                            setSelectedIds(
                                new Set(cart.map((item) => item.id))
                            );
                        } else {
                            setSelectedIds(new Set());
                        }
                        render();
                    };
                }

                // After rendering, update the summary (selected count and subtotal)
                updateCartSummary();
            }

            // Search submit
            function handleSearch(event) {
                event.preventDefault();
                const q = document.getElementById("searchInput").value.trim();
                if (q) {
                    window.location.href = `products.html?search=${encodeURIComponent(
                        q
                    )}`;
                }
            }
            window.handleSearch = handleSearch;

            // Show toast message
            function showToast(message, type = "info") {
                const toast = document.createElement("div");
                toast.className = `toast toast-${type}`;
                toast.style.position = "fixed";
                toast.style.bottom = "20px";
                toast.style.right = "20px";
                toast.style.padding = "12px 24px";
                toast.style.background =
                    type === "success"
                        ? "#4caf50"
                        : type === "error"
                        ? "#f44336"
                        : type === "warning"
                        ? "#ff9800"
                        : "#2196f3";
                toast.style.color = "white";
                toast.style.borderRadius = "4px";
                toast.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
                toast.style.zIndex = "1000";
                toast.style.transition = "opacity 0.3s, transform 0.3s";
                toast.style.transform = "translateY(20px)";
                toast.style.opacity = "0";
                toast.textContent = message;

                document.body.appendChild(toast);

                // Trigger reflow
                setTimeout(() => {
                    toast.style.transform = "translateY(0)";
                    toast.style.opacity = "1";
                }, 10);

                // Remove after delay
                setTimeout(() => {
                    toast.style.opacity = "0";
                    toast.style.transform = "translateY(-20px)";
                    setTimeout(() => {
                        if (toast.parentNode) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }

            // Initialize the page
            document.addEventListener("DOMContentLoaded", () => {
                updateCartBadge();
                render();
                updateCartSummary();

                // Add event listener for search form if it exists
                const searchForm = document.getElementById("searchForm");
                if (searchForm) {
                    searchForm.addEventListener("submit", handleSearch);
                }
            });
        </script>
    </body>
</html>
